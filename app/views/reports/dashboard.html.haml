%p.utility_bar
  = link_to "Download Yesterday's Data", article_view_csv_path(@user[:key]), :class => "csv"
%h1 Showing all articles

%date
  =form_tag dashboard_path(@user[:key]), :method => :get do
    == from #{text_field_tag(:start_date, I18n.l(@start_date), {:id => "start_date"})}
    == to #{text_field_tag(:end_date, I18n.l(@end_date), {:id => "end_date"})}
    = submit_tag "Update"
%br
%hr

%h2 Readers Viewing My Articles
#page_view_plot

%h2.summary== Your articles were viewed #{@total_view_count} times in total.
#sources_loading
  = render 'loading_indicator'
#source_chart

%h2 Which of My Articles People Are Reading?
#articles_loading
  = render 'loading_indicator'
%table#articles
  
%h2 How Are People Finding Me?
#keyphrases
  %table
    %thead
      %tr
        %th.first Keyphrases
        %th Views
    %tbody
  .loading
    = render 'loading_indicator'
  .more
    %a{:href => ""} More

%h2 Where Are My Readers Coming From?
#domains_loading
  = render 'loading_indicator'
%table#domains

-# var keyphrases = $("#keyphrases");
-# 
-# $.get("#{writer_keyphrases_url(@user[:key], @user[:id])}", {}, function(html){
-#   $(".loading", keyphrases).hide();
-#   $("table", keyphrases).append(html);
-# }); 
-# 
-# $(".more", keyphrases).click(function(){
-#   $(".loading", keyphrases).show();
-#   $.get("#{writer_keyphrases_url(@user[:key], @user[:id])}", {limit : 20, offset : $("tbody tr", keyphrases).length}, function(data){
-#       $("table", keyphrases).append(data);
-#       $(".loading", keyphrases).hide();
-#     }
-#   );
-#   return false;
-# });

- content_for :page_javascript do
  :javascript
    $(function(){
      
      // Render the sources asynchronously
      $.getJSON("#{writer_sources_url(@user[:key], @user[:id])}", {}, function(data){
        $("#sources_loading").hide();
        $('#source_chart').addClass("source_chart").source_chart(data);
      });
      
      // Render the article counts asynchronously
      $("#articles").load("#{writer_articles_url(@user[:key], @user[:id])}", {}, function(){
        $("#articles_loading").hide();
      });
      
      // Render the domain counts asynchronously
      $("#domains").load("#{writer_domains_url(@user[:key], @user[:id])}", {}, function(){
        $("#domains_loading").hide();
      });
      
      // Render the keyphrase counts asynchronously
      $("#keyphrases").paginated_table("#{writer_keyphrases_url(@user[:key], @user[:id])}");
      
      var dates = $( "#start_date, #end_date" ).datepicker({
        numberOfMonths: 1,
        minDate: new Date(2011, 1-1, 1),
        onSelect: function( selectedDate ) {
          var option = this.id == "start_date" ? "minDate" : "maxDate",
          instance = $( this ).data( "datepicker" ),
          date = $.datepicker.parseDate(
          instance.settings.dateFormat ||
          $.datepicker._defaults.dateFormat,
          selectedDate, instance.settings );
          dates.not( this ).datepicker( "option", option, date );
        }
      });
      $.datepicker.setDefaults($.datepicker.regional["#{I18n.locale.to_s}"]);
  		
      // Make the 'page_view_plot' div a highchart showing the total view counts.
      $('#page_view_plot').page_view_plot(#{@view_counts.to_json}, #{@start_date.at_midnight.to_i * 1000});
      
    });
  