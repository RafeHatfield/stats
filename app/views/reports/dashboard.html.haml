= link_to 'Back to MySuite', 'http://mysuite.suite101.com'

%h1
  = I18n.t('report.header')
%date
  =form_tag dashboard_path(@user[:key]), :method => :get do
    == #{I18n.t('report.start_date')} #{text_field_tag(:start_date, I18n.l(@start_date), {:id => "start_date"})}
    == #{I18n.t('report.end_date')} #{text_field_tag(:end_date, I18n.l(@end_date), {:id => "end_date"})}
    = submit_tag I18n.t('report.update')
%br
%p.csv=link_to I18n.t('report.download_data'), article_view_csv_path(@user[:id], @user[:key])  

%h2= I18n.t('report.page_view_graph_header')
#page_view_plot

%h2.summary= I18n.t('report.article_views_line').gsub('[articles_views]', "#{@number_of_articles_with_views}").gsub('[total_views]', "#{@total_view_count}")
#source_chart

%h2= I18n.t('report.articles_header')
%table#article_counts_full.rounded-corner
  = render 'article_stats/articles_stats', :articles_stats => @article_counts

%h2= I18n.t('report.keyword_header')
%table.rounded-corner
  %thead
    %tr
      %th.rounded-left Keyphrases
      %th.rounded-tab2-right ...
  %tfoot
    %tr
      %td.rounded-foot{:colspan => 2, :height => 15}
  - @keyphrase_counts.each do |k|
    %tr
      %td= k[0]
      %td= k[1]
      
%h2= I18n.t('report.domain_header')
%table.rounded-corner
  %thead
    %tr
      %th.rounded-left Domains
      %th.rounded-tab2-right ...
  %tfoot
    %tr
      %td.rounded-foot{:colspan => 2, :height => 15}
  - @domain_counts.each do |k|
    %tr
      %td= k[0].blank? ? "[direct]" : k[0]
      %td= k[1]

- content_for :page_javascript do
  = javascript_include_tag 'jquery.highcharts.page-view-plot'
  = javascript_include_tag 'jquery.highcharts.source-chart'
  :javascript
    $(function(){
      
      $("#pagination a").live("click", function() {
          $.get(this.href, function(data) {
            $('#article_counts_full').html(data);
          });
          return false;
      });
      
      var dates = $( "#start_date, #end_date" ).datepicker({
        numberOfMonths: 1,
        minDate: new Date(2011, 1-1, 1),
        onSelect: function( selectedDate ) {
          var option = this.id == "start_date" ? "minDate" : "maxDate",
          instance = $( this ).data( "datepicker" ),
          date = $.datepicker.parseDate(
          instance.settings.dateFormat ||
          $.datepicker._defaults.dateFormat,
          selectedDate, instance.settings );
          dates.not( this ).datepicker( "option", option, date );
        }
      });
      
      $.datepicker.setDefaults($.datepicker.regional["#{I18n.locale.to_s}"]);
  		
      // Make the 'page_view_plot' div a highchart showing the total view counts.
      $('#page_view_plot').page_view_plot({
        series: [{
          name: 'This week',
          pointInterval: #{1.day * 1000},
          pointStart: #{@start_date.at_midnight.to_i * 1000},
          data: #{prepare_data(@view_counts, @start_date, @end_date)}
        }]
      })      
      
      $('#source_chart').source_chart({
         series: [{
           type: 'pie',
           data: #{@source_counts.map{|source_sym, count| [I18n.t("report.#{source_sym.to_s}"), count]}.to_json}
        }]
      })
    });
  